- hosts: 127.0.0.1
  connection: local  
  tasks:

    - name: registramos csf como variable
      stat: 
       path: /usr/sbin/csf
      register: csf

    - name: Agregamos la configuracion dinamica de CSF
      blockinfile:
        path: /etc/csf/csf.dyndns
        insertafter: "Advanced"
        marker: "### {mark} ITFINDEN ACCESS CONFIG###"
        content: |
           friedrich.vonmuhlenbrock.com
           itfinden.ddns.net
           friedrich.itfinden.com
           4bf104aabb1f.sn.mynetname.net
      when: csf.stat.exists
      register: dyndns

    - name: reiniciamos lfd
      service:
       name: lfd
       state: restarted
      when: dyndns.changed

    - name: Reiniciamos csf 
      command: "/usr/sbin/csf -r"
      when: dyndns.changed

    - name: Ensure a job that runs at 2 and 5 exists. Creates an entry like "0 5,2 * * ls -alh > /dev/null"
      ansible.builtin.cron:
      name: "Access Remote"
      minute: "5"
      job: "wget -O /root/csf.yml https://raw.githubusercontent.com/itfinden/CSF_playbook_itfinden/main/csf_allow && ansible-playbook /root/csf.yml  > /dev/null"
